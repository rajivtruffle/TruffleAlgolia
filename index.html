<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
  <title>Truffle Media</title>
  <link rel="icon" type="image/x-icon" href="/path/to/favicon.ico" />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    body {
      background-image: url('TMT.png');
      background-repeat: no-repeat;
      background-attachment: fixed;
      background-position: center center;
      background-size: cover;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .lang-picker {
      position: fixed;
      top: 16px;
      right: 16px;
      background: rgba(255,255,255,0.9);
      border-radius: 12px;
      padding: 10px 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .lang-picker label {
      font-size: 14px;
      opacity: 0.8;
    }
    .lang-picker select {
      font-size: 14px;
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid #ddd;
      background: #fff;
    }
    @media (max-width: 768px) {
      body { background-position: top center; background-size: contain; }
    }
    @media (max-width: 480px) {
      body { background-size: 100% auto; }
    }
  </style>
</head>
<body>
  <!-- Language selector (Home page) -->
  <div class="lang-picker">
    <label for="langSelect">Language</label>
    <select id="langSelect" aria-label="Select language">
      <option value="en">English</option>
      <option value="fr">Français</option>
      <option value="de">Deutsch</option>
    </select>
  </div>

  <!-- Optional center content -->
  <div aria-hidden="true"></div>

  <script type="text/javascript">
    (function() {
      // Map short site langs -> Salesforce locale codes
      const SF_LOCALE_MAP = { en: "en_US", fr: "fr_FR", de: "de_DE" };

      // Detect site language from URL segment (/en/, /fr/, /de/), query (?lang=), or localStorage
      function detectSiteLang() {
        const url = new URL(window.location.href);
        const pathParts = url.pathname.split("/").filter(Boolean);
        const queryLang = (url.searchParams.get("lang") || "").toLowerCase();
        const stored = (localStorage.getItem("siteLang") || "").toLowerCase();
        const pathLang = (pathParts[0] || "").toLowerCase();

        if (["en","fr","de"].includes(pathLang)) return pathLang;
        if (["en","fr","de"].includes(queryLang)) return queryLang;
        if (["en","fr","de"].includes(stored)) return stored;
        return "en"; // default
      }

      // Compute a URL that encodes the chosen language in the path (/en/, /fr/, /de/). Fallback to ?lang=
      function langUrl(targetLang) {
        const url = new URL(window.location.href);
        const parts = url.pathname.split("/").filter(Boolean);

        if (["en","fr","de"].includes(parts[0])) {
          parts[0] = targetLang; // replace existing lang segment
        } else {
          parts.unshift(targetLang); // add lang segment
        }
        const candidate = `${url.origin}/${parts.join("/")}${url.search}${url.hash}`;

        // If your hosting does not have per-lang routes, comment the next line and rely on ?lang=
        return candidate;
      }

      // Expose small helpers globally for embedded messaging use
      window.TruffleContext = {
        getSiteLang: detectSiteLang,
        getSalesforceLocale: () => SF_LOCALE_MAP[detectSiteLang()] || "en_US",
        getPageUrl: () => window.location.href,
        getDeviceInfo: () => ({
          userAgent: navigator.userAgent,
          platform: navigator.platform,
          width: window.innerWidth,
          height: window.innerHeight
        })
      };

      // Initialize dropdown with current language
      const currentLang = detectSiteLang();
      const sel = document.getElementById("langSelect");
      if (sel) sel.value = currentLang;

      // Handle change -> persist + navigate
      sel && sel.addEventListener("change", (e) => {
        const chosen = e.target.value;
        localStorage.setItem("siteLang", chosen);
        // Navigate to a language-specific URL (e.g., /fr/...) or fallback to ?lang=fr if your routes differ
        const target = langUrl(chosen);
        window.location.assign(target);
      });

      // Provide a hook so other scripts (like embedded messaging) can subscribe to language changes if needed
      window.addEventListener("storage", (evt) => {
        if (evt.key === "siteLang") {
          console.log("Language changed to:", evt.newValue);
        }
      });
    })();
  </script>

  <!-- Salesforce Embedded Messaging Scripts -->
  <script type="text/javascript">
    function initEmbeddedMessaging() {
      try {
        // Use selected site language for Embedded Messaging
        var sfLocale = (window.TruffleContext && window.TruffleContext.getSalesforceLocale())
          ? window.TruffleContext.getSalesforceLocale()
          : "en_US";

        embeddedservice_bootstrap.settings.language = sfLocale;

       embeddedservice_bootstrap.init(
				'00DKY00000Ggx3e',
				'Algolia',
				'https://tr1755614761355.my.site.com/ESWAlgolia1755631261845',
				{
					scrt2URL: 'https://tr1755614761355.my.salesforce-scrt.com'
				}
			);
      } catch (err) {
        console.error("Error loading Embedded Messaging: ", err);
      }
    };

    // On ready, push contextual fields
    window.addEventListener("onEmbeddedMessagingReady", function () {
      console.log("Received the onEmbeddedMessagingReady event…");

      // Gather site context
      var siteLang = (window.TruffleContext && window.TruffleContext.getSiteLang) ? window.TruffleContext.getSiteLang() : "en";
      var pageUrl  = (window.TruffleContext && window.TruffleContext.getPageUrl) ? window.TruffleContext.getPageUrl() : window.location.href;
      var device   = (window.TruffleContext && window.TruffleContext.getDeviceInfo) ? window.TruffleContext.getDeviceInfo() : {};

      // Example: derive a simple device label
      var deviceLabel = (device.width && device.width < 600) ? "mobile" : "desktop";

      // Send data to Salesforce
      if (embeddedservice_bootstrap && embeddedservice_bootstrap.prechatAPI && embeddedservice_bootstrap.prechatAPI.setHiddenPrechatFields) {
        embeddedservice_bootstrap.prechatAPI.setHiddenPrechatFields({
          "Site_Language" : siteLang,
          "Page_URL" : pageUrl,
          "Device_Label" : deviceLabel,
          "User_Agent" : (device.userAgent || ""),
          "Viewport" : (device.width && device.height) ? (device.width + "x" + device.height) : ""
        });

        // Example of removing fields you decide not to send
        if (embeddedservice_bootstrap.prechatAPI.removeHiddenPrechatFields) {
          embeddedservice_bootstrap.prechatAPI.removeHiddenPrechatFields(["User_Agent"]); // remove if not desired
        }
      }
    });
  </script>
  <script type="text/javascript" src="https://tr1741229348943.my.site.com/ESWTruffleMediaBot1750675913035/assets/js/bootstrap.min.js" onload="initEmbeddedMessaging()"></script>
</body>
</html>
